<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>BX/Library.hs</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
<pre><a name="line-1"></a><span class='hs-comment'>{-# Language TemplateHaskell, TypeFamilies #-}</span>
<a name="line-2"></a>
<a name="line-3"></a><span class='hs-keyword'>module</span> <span class='hs-conid'>BX</span><span class='hs-varop'>.</span><span class='hs-conid'>Library</span> <span class='hs-keyword'>where</span>
<a name="line-4"></a>
<a name="line-5"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Generics</span><span class='hs-varop'>.</span><span class='hs-conid'>BiGUL</span>
<a name="line-6"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>List</span>
<a name="line-7"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Generics</span><span class='hs-varop'>.</span><span class='hs-conid'>BiGUL</span><span class='hs-varop'>.</span><span class='hs-conid'>Interpreter</span>
<a name="line-8"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Generics</span><span class='hs-varop'>.</span><span class='hs-conid'>BiGUL</span><span class='hs-varop'>.</span><span class='hs-conid'>TH</span>
<a name="line-9"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Control</span><span class='hs-varop'>.</span><span class='hs-conid'>Arrow</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varop'>***</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-10"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Maybe</span>
<a name="line-11"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Array</span><span class='hs-varop'>.</span><span class='hs-conid'>ST</span>
<a name="line-12"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Array</span>
<a name="line-13"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Control</span><span class='hs-varop'>.</span><span class='hs-conid'>Monad</span><span class='hs-varop'>.</span><span class='hs-conid'>ST</span>
<a name="line-14"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Control</span><span class='hs-varop'>.</span><span class='hs-conid'>Monad</span>
<a name="line-15"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Debug</span><span class='hs-varop'>.</span><span class='hs-conid'>Trace</span>
<a name="line-16"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Text</span><span class='hs-varop'>.</span><span class='hs-conid'>Show</span><span class='hs-varop'>.</span><span class='hs-conid'>Pretty</span>
<a name="line-17"></a>
<a name="line-18"></a>
<a name="line-19"></a><a name="==%3e"></a><span class='hs-comment'>-- | make it more elegant to write ($) in 'Case' branches.</span>
<a name="line-20"></a><span class='hs-layout'>(</span><span class='hs-varop'>==&gt;</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>b</span>
<a name="line-21"></a><span class='hs-layout'>(</span><span class='hs-varop'>==&gt;</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varop'>$</span><span class='hs-layout'>)</span>
<a name="line-22"></a>
<a name="line-23"></a><a name="emb"></a><span class='hs-comment'>-- | emb g p: invoke g to do the get, and invoke p to do the put.</span>
<a name="line-24"></a><span class='hs-definition'>emb</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Eq</span> <span class='hs-varid'>v</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>s</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>s</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>v</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>s</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>BiGUL</span> <span class='hs-varid'>s</span> <span class='hs-varid'>v</span>
<a name="line-25"></a><span class='hs-definition'>emb</span> <span class='hs-varid'>g</span> <span class='hs-varid'>p</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Case</span>
<a name="line-26"></a>  <span class='hs-keyglyph'>[</span> <span class='hs-varop'>$</span><span class='hs-layout'>(</span><span class='hs-varid'>normal</span> <span class='hs-keyglyph'>[</span><span class='hs-keyglyph'>|</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>s</span> <span class='hs-varid'>v</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>g</span> <span class='hs-varid'>s</span> <span class='hs-varop'>==</span> <span class='hs-varid'>v</span> <span class='hs-keyglyph'>|</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>p</span><span class='hs-keyglyph'>|</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>|</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-27"></a>    <span class='hs-varop'>==&gt;</span> <span class='hs-conid'>Skip</span> <span class='hs-varid'>g</span>
<a name="line-28"></a>  <span class='hs-layout'>,</span> <span class='hs-varop'>$</span><span class='hs-layout'>(</span><span class='hs-varid'>adaptive</span> <span class='hs-keyglyph'>[</span><span class='hs-keyglyph'>|</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>s</span> <span class='hs-varid'>v</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span> <span class='hs-keyglyph'>|</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-29"></a>    <span class='hs-varop'>==&gt;</span> <span class='hs-varid'>p</span>
<a name="line-30"></a>  <span class='hs-keyglyph'>]</span>
<a name="line-31"></a>
<a name="line-32"></a><a name="mapLens"></a><span class='hs-comment'>-- | A lens which takes a BiGUL program and yields another BiGUL program working on list.</span>
<a name="line-33"></a><span class='hs-definition'>mapLens</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>Show</span> <span class='hs-varid'>a</span><span class='hs-layout'>,</span> <span class='hs-conid'>Show</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span>
<a name="line-34"></a>        <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>BiGUL</span> <span class='hs-varid'>a</span> <span class='hs-varid'>b</span>            <span class='hs-comment'>-- ^ The inner BX</span>
<a name="line-35"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>b</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>             <span class='hs-comment'>-- ^ The function to create a source element from the view when the source is empty</span>
<a name="line-36"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>BiGUL</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>a</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>b</span><span class='hs-keyglyph'>]</span>
<a name="line-37"></a><span class='hs-definition'>mapLens</span> <span class='hs-varid'>b</span> <span class='hs-varid'>create</span> <span class='hs-keyglyph'>=</span>
<a name="line-38"></a>  <span class='hs-conid'>Case</span>  <span class='hs-keyglyph'>[</span> <span class='hs-varop'>$</span><span class='hs-layout'>(</span><span class='hs-varid'>normalSV</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>p</span><span class='hs-keyglyph'>|</span> <span class='hs-keyword'>_</span><span class='hs-conop'>:</span><span class='hs-keyword'>_</span> <span class='hs-keyglyph'>|</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>p</span><span class='hs-keyglyph'>|</span> <span class='hs-keyword'>_</span><span class='hs-conop'>:</span><span class='hs-keyword'>_</span> <span class='hs-keyglyph'>|</span><span class='hs-keyglyph'>]</span>
<a name="line-39"></a>                     <span class='hs-keyglyph'>[</span><span class='hs-varid'>p</span><span class='hs-keyglyph'>|</span> <span class='hs-keyword'>_</span><span class='hs-conop'>:</span><span class='hs-keyword'>_</span> <span class='hs-keyglyph'>|</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-40"></a>          <span class='hs-varop'>==&gt;</span> <span class='hs-varop'>$</span><span class='hs-layout'>(</span><span class='hs-varid'>update</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>p</span><span class='hs-keyglyph'>|</span> <span class='hs-varid'>x</span><span class='hs-conop'>:</span><span class='hs-varid'>xs</span> <span class='hs-keyglyph'>|</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>p</span><span class='hs-keyglyph'>|</span> <span class='hs-varid'>x</span><span class='hs-conop'>:</span><span class='hs-varid'>xs</span> <span class='hs-keyglyph'>|</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>d</span><span class='hs-keyglyph'>|</span> <span class='hs-varid'>x</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>b</span><span class='hs-layout'>;</span> <span class='hs-varid'>xs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapLens</span> <span class='hs-varid'>b</span> <span class='hs-varid'>create</span> <span class='hs-keyglyph'>|</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-41"></a>        <span class='hs-layout'>,</span> <span class='hs-varop'>$</span><span class='hs-layout'>(</span><span class='hs-varid'>adaptiveSV</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>p</span><span class='hs-keyglyph'>|</span> <span class='hs-keyword'>_</span><span class='hs-conop'>:</span><span class='hs-keyword'>_</span> <span class='hs-keyglyph'>|</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>p</span><span class='hs-keyglyph'>|</span> <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>|</span><span class='hs-keyglyph'>]</span> <span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>[]</span><span class='hs-layout'>)</span>
<a name="line-42"></a>        <span class='hs-layout'>,</span> <span class='hs-varop'>$</span><span class='hs-layout'>(</span><span class='hs-varid'>adaptiveSV</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>p</span><span class='hs-keyglyph'>|</span> <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>|</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>p</span><span class='hs-keyglyph'>|</span> <span class='hs-keyword'>_</span><span class='hs-conop'>:</span><span class='hs-keyword'>_</span> <span class='hs-keyglyph'>|</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-43"></a>          <span class='hs-varop'>==&gt;</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>s</span> <span class='hs-layout'>(</span><span class='hs-varid'>v</span><span class='hs-conop'>:</span><span class='hs-varid'>vs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>create</span> <span class='hs-varid'>v</span> <span class='hs-keyglyph'>]</span>
<a name="line-44"></a>        <span class='hs-layout'>,</span> <span class='hs-varop'>$</span><span class='hs-layout'>(</span><span class='hs-varid'>normalSV</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>p</span><span class='hs-keyglyph'>|</span> <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>|</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>p</span><span class='hs-keyglyph'>|</span> <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>|</span><span class='hs-keyglyph'>]</span>
<a name="line-45"></a>                     <span class='hs-keyglyph'>[</span><span class='hs-varid'>p</span><span class='hs-keyglyph'>|</span> <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>|</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-46"></a>          <span class='hs-varop'>==&gt;</span> <span class='hs-varop'>$</span><span class='hs-layout'>(</span><span class='hs-varid'>update</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>p</span><span class='hs-keyglyph'>|</span> <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>|</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>p</span><span class='hs-keyglyph'>|</span> <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>|</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>d</span><span class='hs-keyglyph'>|</span> <span class='hs-keyglyph'>|</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-47"></a>        <span class='hs-keyglyph'>]</span>
<a name="line-48"></a>
<a name="line-49"></a><a name="filterLens"></a><span class='hs-comment'>-- | A lens which takes a predicate @ p @ and yields a BiGUL program whose get-direction is equivalent to @ filter p @</span>
<a name="line-50"></a><span class='hs-definition'>filterLens</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>Show</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>BiGUL</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>a</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>a</span><span class='hs-keyglyph'>]</span>
<a name="line-51"></a><span class='hs-definition'>filterLens</span> <span class='hs-varid'>f</span> <span class='hs-keyglyph'>=</span> 
<a name="line-52"></a>    <span class='hs-conid'>Case</span> <span class='hs-keyglyph'>[</span> <span class='hs-comment'>-- Case 1: [] []</span>
<a name="line-53"></a>           <span class='hs-varop'>$</span><span class='hs-layout'>(</span><span class='hs-varid'>normal</span> <span class='hs-keyglyph'>[</span><span class='hs-keyglyph'>|</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>s</span> <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>null</span> <span class='hs-varop'>.</span> <span class='hs-varid'>filter</span> <span class='hs-varid'>f</span><span class='hs-layout'>)</span> <span class='hs-varid'>s</span> <span class='hs-keyglyph'>|</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>[</span><span class='hs-keyglyph'>|</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>s</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>null</span> <span class='hs-varop'>.</span> <span class='hs-varid'>filter</span> <span class='hs-varid'>f</span><span class='hs-layout'>)</span> <span class='hs-varid'>s</span> <span class='hs-keyglyph'>|</span><span class='hs-keyglyph'>]</span> <span class='hs-layout'>)</span>
<a name="line-54"></a>           <span class='hs-layout'>(</span><span class='hs-varop'>$</span><span class='hs-layout'>(</span><span class='hs-varid'>rearrV</span> <span class='hs-keyglyph'>[</span><span class='hs-keyglyph'>|</span> <span class='hs-keyglyph'>\</span><span class='hs-conid'>[]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>()</span> <span class='hs-keyglyph'>|</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>Skip</span> <span class='hs-layout'>(</span><span class='hs-varid'>const</span> <span class='hs-conid'>()</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-55"></a>
<a name="line-56"></a>           <span class='hs-comment'>-- Case 1': s:ss [], =&gt; make s empty</span>
<a name="line-57"></a>           <span class='hs-varop'>$</span><span class='hs-layout'>(</span><span class='hs-varid'>adaptiveSV</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>p</span><span class='hs-keyglyph'>|</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>|</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>p</span><span class='hs-keyglyph'>|</span> <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>|</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-58"></a>           <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>s</span> <span class='hs-varid'>v</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>filter</span> <span class='hs-layout'>(</span><span class='hs-varid'>not</span> <span class='hs-varop'>.</span> <span class='hs-varid'>f</span><span class='hs-layout'>)</span> <span class='hs-varid'>s</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-59"></a>
<a name="line-60"></a>           <span class='hs-comment'>-- Case 2: [] v:vs, not f v =&gt; fail</span>
<a name="line-61"></a>           <span class='hs-varop'>$</span><span class='hs-layout'>(</span><span class='hs-varid'>normal</span> <span class='hs-keyglyph'>[</span><span class='hs-keyglyph'>|</span> <span class='hs-keyglyph'>\</span><span class='hs-conid'>[]</span> <span class='hs-layout'>(</span><span class='hs-varid'>v</span><span class='hs-conop'>:</span><span class='hs-varid'>vs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>f</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>[</span><span class='hs-keyglyph'>|</span> <span class='hs-varid'>const</span> <span class='hs-conid'>False</span> <span class='hs-keyglyph'>|</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-62"></a>           <span class='hs-layout'>(</span><span class='hs-conid'>Fail</span> <span class='hs-str'>"invalid view"</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-63"></a>
<a name="line-64"></a>           <span class='hs-comment'>-- Case 3: [] v:vs, f v =&gt; add v to source</span>
<a name="line-65"></a>           <span class='hs-varop'>$</span><span class='hs-layout'>(</span><span class='hs-varid'>adaptive</span> <span class='hs-keyglyph'>[</span><span class='hs-keyglyph'>|</span> <span class='hs-keyglyph'>\</span><span class='hs-conid'>[]</span> <span class='hs-layout'>(</span><span class='hs-varid'>v</span><span class='hs-conop'>:</span><span class='hs-varid'>vs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>f</span> <span class='hs-varid'>v</span> <span class='hs-keyglyph'>|</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-66"></a>           <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>s</span> <span class='hs-layout'>(</span><span class='hs-varid'>v</span><span class='hs-conop'>:</span><span class='hs-varid'>vs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>v</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-67"></a>
<a name="line-68"></a>           <span class='hs-comment'>-- Case 4: s:ss _, not f s =&gt; rearrS</span>
<a name="line-69"></a>           <span class='hs-varop'>$</span><span class='hs-layout'>(</span><span class='hs-varid'>normal</span> <span class='hs-keyglyph'>[</span><span class='hs-keyglyph'>|</span> <span class='hs-keyglyph'>\</span><span class='hs-layout'>(</span><span class='hs-varid'>s</span><span class='hs-conop'>:</span><span class='hs-varid'>ss</span><span class='hs-layout'>)</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>f</span> <span class='hs-varid'>s</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>[</span><span class='hs-keyglyph'>|</span> <span class='hs-keyglyph'>\</span><span class='hs-layout'>(</span><span class='hs-varid'>s</span><span class='hs-conop'>:</span><span class='hs-varid'>ss</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>f</span> <span class='hs-varid'>s</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span><span class='hs-keyglyph'>]</span> <span class='hs-layout'>)</span>
<a name="line-70"></a>           <span class='hs-layout'>(</span><span class='hs-varop'>$</span><span class='hs-layout'>(</span><span class='hs-varid'>rearrS</span> <span class='hs-keyglyph'>[</span><span class='hs-keyglyph'>|</span> <span class='hs-keyglyph'>\</span><span class='hs-layout'>(</span><span class='hs-varid'>s</span><span class='hs-conop'>:</span><span class='hs-varid'>ss</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>ss</span> <span class='hs-keyglyph'>|</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>filterLens</span> <span class='hs-varid'>f</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-71"></a>
<a name="line-72"></a>           <span class='hs-comment'>-- Case 5: s:ss v:vs, f s &amp;&amp; f v =&gt; Replace and recursion</span>
<a name="line-73"></a>           <span class='hs-varop'>$</span><span class='hs-layout'>(</span><span class='hs-varid'>normal</span> <span class='hs-keyglyph'>[</span><span class='hs-keyglyph'>|</span> <span class='hs-keyglyph'>\</span><span class='hs-layout'>(</span><span class='hs-varid'>s</span><span class='hs-conop'>:</span><span class='hs-varid'>ss</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>v</span><span class='hs-conop'>:</span><span class='hs-varid'>vs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>f</span> <span class='hs-varid'>s</span><span class='hs-layout'>)</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-layout'>(</span><span class='hs-varid'>f</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>[</span><span class='hs-keyglyph'>|</span> <span class='hs-keyglyph'>\</span><span class='hs-layout'>(</span><span class='hs-varid'>s</span><span class='hs-conop'>:</span><span class='hs-varid'>ss</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>f</span> <span class='hs-varid'>s</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span><span class='hs-keyglyph'>]</span> <span class='hs-layout'>)</span>
<a name="line-74"></a>           <span class='hs-varop'>$</span><span class='hs-layout'>(</span><span class='hs-varid'>update</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>p</span><span class='hs-keyglyph'>|</span> <span class='hs-varid'>x</span><span class='hs-conop'>:</span><span class='hs-varid'>xs</span> <span class='hs-keyglyph'>|</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>p</span><span class='hs-keyglyph'>|</span> <span class='hs-varid'>x</span><span class='hs-conop'>:</span><span class='hs-varid'>xs</span> <span class='hs-keyglyph'>|</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>d</span><span class='hs-keyglyph'>|</span> <span class='hs-varid'>x</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Replace</span><span class='hs-layout'>;</span> <span class='hs-varid'>xs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>filterLens</span> <span class='hs-varid'>f</span> <span class='hs-keyglyph'>|</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-75"></a>
<a name="line-76"></a>           <span class='hs-comment'>-- Case 5': s:ss v:vs, f s &amp;&amp; not (f v) =&gt; fail</span>
<a name="line-77"></a>           <span class='hs-varop'>$</span><span class='hs-layout'>(</span><span class='hs-varid'>normal</span> <span class='hs-keyglyph'>[</span><span class='hs-keyglyph'>|</span> <span class='hs-keyglyph'>\</span><span class='hs-layout'>(</span><span class='hs-varid'>s</span><span class='hs-conop'>:</span><span class='hs-varid'>ss</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>v</span><span class='hs-conop'>:</span><span class='hs-varid'>vs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>f</span> <span class='hs-varid'>s</span><span class='hs-layout'>)</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>f</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>[</span><span class='hs-keyglyph'>|</span> <span class='hs-varid'>const</span> <span class='hs-conid'>False</span> <span class='hs-keyglyph'>|</span><span class='hs-keyglyph'>]</span> <span class='hs-layout'>)</span>
<a name="line-78"></a>           <span class='hs-layout'>(</span><span class='hs-conid'>Fail</span> <span class='hs-str'>"invalid view"</span><span class='hs-layout'>)</span>
<a name="line-79"></a>        <span class='hs-keyglyph'>]</span>
<a name="line-80"></a>
<a name="line-81"></a>
<a name="line-82"></a><a name="expandLens"></a><span class='hs-definition'>expandLens</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>Eq</span> <span class='hs-varid'>a</span><span class='hs-layout'>,</span> <span class='hs-conid'>Show</span> <span class='hs-varid'>a</span><span class='hs-layout'>,</span> <span class='hs-conid'>Eq</span> <span class='hs-varid'>b</span><span class='hs-layout'>,</span> <span class='hs-conid'>Show</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>Bool</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>BiGUL</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-varid'>a</span><span class='hs-layout'>,</span><span class='hs-varid'>b</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-varid'>a</span><span class='hs-layout'>,</span><span class='hs-keyglyph'>[</span><span class='hs-varid'>b</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-83"></a><span class='hs-definition'>expandLens</span> <span class='hs-varid'>check</span> <span class='hs-keyglyph'>=</span> 
<a name="line-84"></a>    <span class='hs-conid'>Case</span> <span class='hs-keyglyph'>[</span> <span class='hs-comment'>-- Case 1: [] []</span>
<a name="line-85"></a>           <span class='hs-varop'>$</span><span class='hs-layout'>(</span><span class='hs-varid'>normalSV</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>p</span><span class='hs-keyglyph'>|</span> <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>|</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>p</span><span class='hs-keyglyph'>|</span> <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>|</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>p</span><span class='hs-keyglyph'>|</span> <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>|</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-86"></a>           <span class='hs-varop'>==&gt;</span> <span class='hs-conid'>Skip</span> <span class='hs-layout'>(</span><span class='hs-varid'>const</span> <span class='hs-conid'>[]</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-87"></a>
<a name="line-88"></a>           <span class='hs-comment'>-- Case 2: [] (view_k, view_v:view_vs):view_kvs =&gt; adaptive add (view_k,view_v) to src</span>
<a name="line-89"></a>           <span class='hs-varop'>$</span><span class='hs-layout'>(</span><span class='hs-varid'>adaptive</span> <span class='hs-keyglyph'>[</span><span class='hs-keyglyph'>|</span> <span class='hs-keyglyph'>\</span><span class='hs-conid'>[]</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>view_k</span><span class='hs-layout'>,</span> <span class='hs-varid'>view_v</span><span class='hs-conop'>:</span><span class='hs-varid'>view_vs</span><span class='hs-layout'>)</span><span class='hs-conop'>:</span><span class='hs-varid'>view_kvs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span> <span class='hs-keyglyph'>|</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-90"></a>           <span class='hs-varop'>==&gt;</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>src</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>view_k</span><span class='hs-layout'>,</span> <span class='hs-varid'>view_v</span><span class='hs-conop'>:</span><span class='hs-varid'>view_vs</span><span class='hs-layout'>)</span><span class='hs-conop'>:</span><span class='hs-varid'>view_kvs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>view_k</span><span class='hs-layout'>,</span> <span class='hs-varid'>view_v</span><span class='hs-layout'>)</span> <span class='hs-conop'>:</span> <span class='hs-varid'>src</span><span class='hs-layout'>)</span> <span class='hs-layout'>,</span>
<a name="line-91"></a>
<a name="line-92"></a>           <span class='hs-comment'>-- Case 3: [] (view_k, []):view_kvs =&gt; Fail</span>
<a name="line-93"></a>           <span class='hs-varop'>$</span><span class='hs-layout'>(</span><span class='hs-varid'>normal</span> <span class='hs-keyglyph'>[</span><span class='hs-keyglyph'>|</span> <span class='hs-keyglyph'>\</span><span class='hs-conid'>[]</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>view_k</span><span class='hs-layout'>,</span> <span class='hs-conid'>[]</span><span class='hs-layout'>)</span><span class='hs-conop'>:</span><span class='hs-varid'>view_kvs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span> <span class='hs-keyglyph'>|</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>[</span><span class='hs-keyglyph'>|</span> <span class='hs-varid'>const</span> <span class='hs-conid'>False</span> <span class='hs-keyglyph'>|</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-94"></a>           <span class='hs-varop'>==&gt;</span> <span class='hs-conid'>Fail</span> <span class='hs-str'>"invalid view 2"</span> <span class='hs-layout'>,</span>
<a name="line-95"></a>
<a name="line-96"></a>           <span class='hs-comment'>-- Case 4: (src_k, src_v):src_kvs [] =&gt; adaptive drop all</span>
<a name="line-97"></a>           <span class='hs-varop'>$</span><span class='hs-layout'>(</span><span class='hs-varid'>adaptive</span> <span class='hs-keyglyph'>[</span><span class='hs-keyglyph'>|</span> <span class='hs-keyglyph'>\</span><span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>src_k</span><span class='hs-layout'>,</span><span class='hs-varid'>src_v</span><span class='hs-layout'>)</span><span class='hs-conop'>:</span><span class='hs-varid'>src_kvs</span><span class='hs-layout'>)</span> <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span> <span class='hs-keyglyph'>|</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-98"></a>           <span class='hs-varop'>==&gt;</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>src</span> <span class='hs-varid'>view</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>[]</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-99"></a>
<a name="line-100"></a>           <span class='hs-comment'>-- Case 5: (src_k, src_v):src_kvs (view_k, []):view_kvs =&gt; Fail</span>
<a name="line-101"></a>           <span class='hs-varop'>$</span><span class='hs-layout'>(</span><span class='hs-varid'>normal</span> <span class='hs-keyglyph'>[</span><span class='hs-keyglyph'>|</span> <span class='hs-keyglyph'>\</span><span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>src_k</span><span class='hs-layout'>,</span><span class='hs-varid'>src_v</span><span class='hs-layout'>)</span><span class='hs-conop'>:</span><span class='hs-varid'>src_kvs</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>view_k</span><span class='hs-layout'>,</span> <span class='hs-conid'>[]</span><span class='hs-layout'>)</span><span class='hs-conop'>:</span><span class='hs-varid'>view_kvs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span> <span class='hs-keyglyph'>|</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>[</span><span class='hs-keyglyph'>|</span> <span class='hs-varid'>const</span> <span class='hs-conid'>False</span> <span class='hs-keyglyph'>|</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-102"></a>           <span class='hs-varop'>==&gt;</span> <span class='hs-conid'>Fail</span> <span class='hs-str'>"invalid view 1"</span> <span class='hs-layout'>,</span>
<a name="line-103"></a>
<a name="line-104"></a>           <span class='hs-comment'>-- Case 6 &amp; 7: (src_k, src_v):src_kvs (view_k, view_v:[]):view_kvs </span>
<a name="line-105"></a>           <span class='hs-comment'>--           =&gt; If src_v != view_v, then add view_v to src else replace and recursion</span>
<a name="line-106"></a>           <span class='hs-varop'>$</span><span class='hs-layout'>(</span><span class='hs-varid'>adaptive</span> <span class='hs-keyglyph'>[</span><span class='hs-keyglyph'>|</span> <span class='hs-keyglyph'>\</span><span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>src_k</span><span class='hs-layout'>,</span><span class='hs-varid'>src_v</span><span class='hs-layout'>)</span><span class='hs-conop'>:</span><span class='hs-varid'>src_kvs</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>view_k</span><span class='hs-layout'>,</span> <span class='hs-varid'>view_v</span><span class='hs-conop'>:</span><span class='hs-conid'>[]</span><span class='hs-layout'>)</span><span class='hs-conop'>:</span><span class='hs-varid'>view_kvs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>src_k</span> <span class='hs-varop'>/=</span> <span class='hs-varid'>view_k</span> <span class='hs-varop'>||</span> <span class='hs-varid'>src_v</span> <span class='hs-varop'>/=</span> <span class='hs-varid'>view_v</span> <span class='hs-keyglyph'>|</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-107"></a>           <span class='hs-varop'>==&gt;</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>src</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>view_k</span><span class='hs-layout'>,</span> <span class='hs-varid'>view_v</span><span class='hs-conop'>:</span><span class='hs-conid'>[]</span><span class='hs-layout'>)</span><span class='hs-conop'>:</span><span class='hs-varid'>view_kvs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>view_k</span><span class='hs-layout'>,</span> <span class='hs-varid'>view_v</span><span class='hs-layout'>)</span> <span class='hs-conop'>:</span> <span class='hs-varid'>src</span><span class='hs-layout'>)</span> <span class='hs-layout'>,</span>
<a name="line-108"></a>
<a name="line-109"></a>           <span class='hs-varop'>$</span><span class='hs-layout'>(</span><span class='hs-varid'>normal</span> <span class='hs-keyglyph'>[</span><span class='hs-keyglyph'>|</span> <span class='hs-keyglyph'>\</span><span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>src_k</span><span class='hs-layout'>,</span><span class='hs-varid'>src_v</span><span class='hs-layout'>)</span><span class='hs-conop'>:</span><span class='hs-varid'>src_kvs</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>view_k</span><span class='hs-layout'>,</span> <span class='hs-varid'>view_v</span><span class='hs-conop'>:</span><span class='hs-conid'>[]</span><span class='hs-layout'>)</span><span class='hs-conop'>:</span><span class='hs-varid'>view_kvs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>src_k</span> <span class='hs-varop'>==</span> <span class='hs-varid'>view_k</span> <span class='hs-varop'>||</span> <span class='hs-varid'>src_v</span> <span class='hs-varop'>==</span> <span class='hs-varid'>view_v</span> <span class='hs-keyglyph'>|</span><span class='hs-keyglyph'>]</span>
<a name="line-110"></a>                    <span class='hs-keyglyph'>[</span><span class='hs-keyglyph'>|</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>src</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>not</span> <span class='hs-varid'>check</span> <span class='hs-varop'>||</span> <span class='hs-layout'>(</span><span class='hs-varid'>length</span> <span class='hs-varid'>src</span> <span class='hs-varop'>==</span> <span class='hs-num'>1</span> <span class='hs-varop'>||</span> <span class='hs-layout'>(</span><span class='hs-varid'>fst</span> <span class='hs-layout'>(</span><span class='hs-varid'>head</span> <span class='hs-varid'>src</span><span class='hs-layout'>)</span> <span class='hs-varop'>/=</span> <span class='hs-varid'>fst</span> <span class='hs-layout'>(</span><span class='hs-varid'>head</span> <span class='hs-layout'>(</span><span class='hs-varid'>tail</span> <span class='hs-varid'>src</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>|</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-111"></a>           <span class='hs-varop'>==&gt;</span> <span class='hs-varop'>$</span><span class='hs-layout'>(</span><span class='hs-varid'>update</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>p</span><span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-varid'>kv</span><span class='hs-conop'>:</span><span class='hs-varid'>kvs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>p</span><span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-varid'>kv</span><span class='hs-conop'>:</span><span class='hs-varid'>kvs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>d</span><span class='hs-keyglyph'>|</span> <span class='hs-varid'>kv</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-conid'>Skip</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-layout'>(</span><span class='hs-varid'>k</span><span class='hs-layout'>,</span><span class='hs-varid'>v</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>k</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>v</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>;</span> <span class='hs-varid'>kvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>expandLens</span> <span class='hs-conid'>True</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span> <span class='hs-layout'>,</span>
<a name="line-112"></a>
<a name="line-113"></a>           <span class='hs-comment'>-- Case 8: (src_k, src_v):src_kvs (view_k, view_v:view_v2:view_vs):view_kvs =&gt; rearrV</span>
<a name="line-114"></a>           <span class='hs-varop'>$</span><span class='hs-layout'>(</span><span class='hs-varid'>normal</span> <span class='hs-keyglyph'>[</span><span class='hs-keyglyph'>|</span> <span class='hs-keyglyph'>\</span><span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span><span class='hs-keyword'>_</span><span class='hs-layout'>)</span><span class='hs-conop'>:</span><span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span><span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-conop'>:</span><span class='hs-keyword'>_</span><span class='hs-conop'>:</span><span class='hs-keyword'>_</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-conop'>:</span><span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span> <span class='hs-keyglyph'>|</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>[</span><span class='hs-keyglyph'>|</span> <span class='hs-keyglyph'>\</span><span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>k1</span><span class='hs-layout'>,</span><span class='hs-keyword'>_</span><span class='hs-layout'>)</span><span class='hs-conop'>:</span><span class='hs-layout'>(</span><span class='hs-varid'>k2</span><span class='hs-layout'>,</span><span class='hs-keyword'>_</span><span class='hs-layout'>)</span><span class='hs-conop'>:</span><span class='hs-varid'>kvs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>k1</span> <span class='hs-varop'>==</span> <span class='hs-varid'>k2</span> <span class='hs-keyglyph'>|</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-115"></a>           <span class='hs-varop'>==&gt;</span> <span class='hs-varop'>$</span><span class='hs-layout'>(</span><span class='hs-varid'>rearrV</span> <span class='hs-keyglyph'>[</span><span class='hs-keyglyph'>|</span> <span class='hs-keyglyph'>\</span><span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>view_k</span><span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-varid'>view_v</span><span class='hs-conop'>:</span><span class='hs-varid'>view_v2</span><span class='hs-conop'>:</span><span class='hs-varid'>view_vs</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-conop'>:</span><span class='hs-varid'>view_kvs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>view_k</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>view_v</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span> <span class='hs-conop'>:</span> <span class='hs-layout'>(</span><span class='hs-varid'>view_k</span><span class='hs-layout'>,</span> <span class='hs-varid'>view_v2</span><span class='hs-conop'>:</span><span class='hs-varid'>view_vs</span><span class='hs-layout'>)</span> <span class='hs-conop'>:</span> <span class='hs-varid'>view_kvs</span> <span class='hs-keyglyph'>|</span><span class='hs-keyglyph'>]</span> <span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>expandLens</span> <span class='hs-conid'>False</span><span class='hs-layout'>)</span>
<a name="line-116"></a>          <span class='hs-keyglyph'>]</span>
<a name="line-117"></a>
<a name="line-118"></a><a name="align"></a><span class='hs-comment'>-- | A lens which tries to align/match the sources with the views, synchronise the matched pairs of sources and views by an inner lens, and process the unmatched sources and views in some programmer-specified ways.</span>
<a name="line-119"></a><span class='hs-definition'>align</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>Show</span> <span class='hs-varid'>a</span><span class='hs-layout'>,</span> <span class='hs-conid'>Show</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span>
<a name="line-120"></a>      <span class='hs-keyglyph'>=&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span><span class='hs-layout'>)</span>       <span class='hs-comment'>-- ^ source condition</span>
<a name="line-121"></a>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>b</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span><span class='hs-layout'>)</span>  <span class='hs-comment'>-- ^ matching condition</span>
<a name="line-122"></a>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>BiGUL</span> <span class='hs-varid'>a</span> <span class='hs-varid'>b</span>         <span class='hs-comment'>-- ^ inner program</span>
<a name="line-123"></a>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>b</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>          <span class='hs-comment'>-- ^ creation</span>
<a name="line-124"></a>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>    <span class='hs-comment'>-- ^ concealment</span>
<a name="line-125"></a>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>BiGUL</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>a</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>b</span><span class='hs-keyglyph'>]</span>
<a name="line-126"></a><span class='hs-definition'>align</span> <span class='hs-varid'>p</span> <span class='hs-varid'>match</span> <span class='hs-varid'>b</span> <span class='hs-varid'>create</span> <span class='hs-varid'>conceal</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Case</span>
<a name="line-127"></a>  <span class='hs-keyglyph'>[</span> <span class='hs-varop'>$</span><span class='hs-layout'>(</span><span class='hs-varid'>normal</span> <span class='hs-keyglyph'>[</span><span class='hs-keyglyph'>|</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>s</span> <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>null</span> <span class='hs-varop'>.</span> <span class='hs-varid'>filter</span> <span class='hs-varid'>p</span><span class='hs-layout'>)</span> <span class='hs-varid'>s</span> <span class='hs-keyglyph'>|</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>[</span><span class='hs-keyglyph'>|</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>s</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>null</span> <span class='hs-varop'>.</span> <span class='hs-varid'>filter</span> <span class='hs-varid'>p</span><span class='hs-layout'>)</span> <span class='hs-varid'>s</span> <span class='hs-keyglyph'>|</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-128"></a>    <span class='hs-varop'>==&gt;</span> <span class='hs-varop'>$</span><span class='hs-layout'>(</span><span class='hs-varid'>rearrV</span> <span class='hs-keyglyph'>[</span><span class='hs-keyglyph'>|</span> <span class='hs-keyglyph'>\</span><span class='hs-conid'>[]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>()</span> <span class='hs-keyglyph'>|</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-129"></a>         <span class='hs-layout'>(</span><span class='hs-conid'>Skip</span> <span class='hs-layout'>(</span><span class='hs-varid'>const</span> <span class='hs-conid'>()</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-130"></a>  <span class='hs-layout'>,</span> <span class='hs-varop'>$</span><span class='hs-layout'>(</span><span class='hs-varid'>adaptiveSV</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>p</span><span class='hs-keyglyph'>|</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>|</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>p</span><span class='hs-keyglyph'>|</span> <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>|</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-131"></a>    <span class='hs-varop'>==&gt;</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>ss</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>catMaybes</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>s</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>p</span> <span class='hs-varid'>s</span> <span class='hs-keyword'>then</span> <span class='hs-varid'>conceal</span> <span class='hs-varid'>s</span> <span class='hs-keyword'>else</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>s</span><span class='hs-layout'>)</span> <span class='hs-varid'>ss</span><span class='hs-layout'>)</span>
<a name="line-132"></a>  <span class='hs-comment'>-- view is necessarily nonempty in the cases below</span>
<a name="line-133"></a>  <span class='hs-layout'>,</span> <span class='hs-varop'>$</span><span class='hs-layout'>(</span><span class='hs-varid'>normal</span> <span class='hs-keyglyph'>[</span><span class='hs-keyglyph'>|</span> <span class='hs-keyglyph'>\</span><span class='hs-layout'>(</span><span class='hs-varid'>s</span><span class='hs-conop'>:</span><span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>p</span> <span class='hs-varid'>s</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>[</span><span class='hs-keyglyph'>|</span> <span class='hs-keyglyph'>\</span><span class='hs-layout'>(</span><span class='hs-varid'>s</span><span class='hs-conop'>:</span><span class='hs-varid'>ss</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>p</span> <span class='hs-varid'>s</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>null</span> <span class='hs-varop'>.</span> <span class='hs-varid'>filter</span> <span class='hs-varid'>p</span><span class='hs-layout'>)</span> <span class='hs-varid'>ss</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>|</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-134"></a>    <span class='hs-varop'>==&gt;</span> <span class='hs-varop'>$</span><span class='hs-layout'>(</span><span class='hs-varid'>rearrS</span> <span class='hs-keyglyph'>[</span><span class='hs-keyglyph'>|</span> <span class='hs-keyglyph'>\</span><span class='hs-layout'>(</span><span class='hs-varid'>s</span><span class='hs-conop'>:</span><span class='hs-varid'>ss</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>ss</span> <span class='hs-keyglyph'>|</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-135"></a>         <span class='hs-layout'>(</span><span class='hs-varid'>align</span> <span class='hs-varid'>p</span> <span class='hs-varid'>match</span> <span class='hs-varid'>b</span> <span class='hs-varid'>create</span> <span class='hs-varid'>conceal</span><span class='hs-layout'>)</span>
<a name="line-136"></a>  <span class='hs-layout'>,</span> <span class='hs-varop'>$</span><span class='hs-layout'>(</span><span class='hs-varid'>normal</span> <span class='hs-keyglyph'>[</span><span class='hs-keyglyph'>|</span> <span class='hs-keyglyph'>\</span><span class='hs-layout'>(</span><span class='hs-varid'>s</span><span class='hs-conop'>:</span><span class='hs-varid'>ss</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>v</span><span class='hs-conop'>:</span><span class='hs-varid'>vs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>p</span> <span class='hs-varid'>s</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>match</span> <span class='hs-varid'>s</span> <span class='hs-varid'>v</span> <span class='hs-keyglyph'>|</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>[</span><span class='hs-keyglyph'>|</span> <span class='hs-keyglyph'>\</span><span class='hs-layout'>(</span><span class='hs-varid'>s</span><span class='hs-conop'>:</span><span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>p</span> <span class='hs-varid'>s</span> <span class='hs-keyglyph'>|</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-137"></a>    <span class='hs-varop'>==&gt;</span> <span class='hs-varop'>$</span><span class='hs-layout'>(</span><span class='hs-varid'>update</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>p</span><span class='hs-keyglyph'>|</span> <span class='hs-varid'>x</span><span class='hs-conop'>:</span><span class='hs-varid'>xs</span> <span class='hs-keyglyph'>|</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>p</span><span class='hs-keyglyph'>|</span> <span class='hs-varid'>x</span><span class='hs-conop'>:</span><span class='hs-varid'>xs</span> <span class='hs-keyglyph'>|</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>d</span><span class='hs-keyglyph'>|</span> <span class='hs-varid'>x</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>b</span><span class='hs-layout'>;</span> <span class='hs-varid'>xs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>align</span> <span class='hs-varid'>p</span> <span class='hs-varid'>match</span> <span class='hs-varid'>b</span> <span class='hs-varid'>create</span> <span class='hs-varid'>conceal</span> <span class='hs-keyglyph'>|</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-138"></a>  <span class='hs-layout'>,</span> <span class='hs-varop'>$</span><span class='hs-layout'>(</span><span class='hs-varid'>adaptive</span> <span class='hs-keyglyph'>[</span><span class='hs-keyglyph'>|</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>ss</span> <span class='hs-layout'>(</span><span class='hs-varid'>v</span><span class='hs-conop'>:</span><span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>isJust</span> <span class='hs-layout'>(</span><span class='hs-varid'>findFirst</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>s</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>p</span> <span class='hs-varid'>s</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>match</span> <span class='hs-varid'>s</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span> <span class='hs-varid'>ss</span><span class='hs-layout'>)</span> <span class='hs-varop'>||</span>
<a name="line-139"></a>                               <span class='hs-keyword'>let</span> <span class='hs-varid'>s</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>create</span> <span class='hs-varid'>v</span> <span class='hs-keyword'>in</span> <span class='hs-varid'>p</span> <span class='hs-varid'>s</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>match</span> <span class='hs-varid'>s</span> <span class='hs-varid'>v</span> <span class='hs-keyglyph'>|</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-140"></a>    <span class='hs-varop'>==&gt;</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>ss</span> <span class='hs-layout'>(</span><span class='hs-varid'>v</span><span class='hs-conop'>:</span><span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>maybe</span> <span class='hs-layout'>(</span><span class='hs-varid'>create</span> <span class='hs-varid'>v</span><span class='hs-conop'>:</span><span class='hs-varid'>ss</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>uncurry</span> <span class='hs-layout'>(</span><span class='hs-conop'>:</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>findFirst</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>s</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>p</span> <span class='hs-varid'>s</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>match</span> <span class='hs-varid'>s</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span> <span class='hs-varid'>ss</span><span class='hs-layout'>)</span>
<a name="line-141"></a>  <span class='hs-keyglyph'>]</span>
<a name="line-142"></a>  <span class='hs-keyword'>where</span>
<a name="line-143"></a>    <span class='hs-varid'>findFirst</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>a</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>a</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-144"></a>    <span class='hs-varid'>findFirst</span> <span class='hs-varid'>p</span> <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-145"></a>    <span class='hs-varid'>findFirst</span> <span class='hs-varid'>p</span> <span class='hs-layout'>(</span><span class='hs-varid'>x</span><span class='hs-conop'>:</span><span class='hs-varid'>xs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>p</span> <span class='hs-varid'>x</span>       <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>x</span><span class='hs-layout'>,</span> <span class='hs-varid'>xs</span><span class='hs-layout'>)</span>
<a name="line-146"></a>    <span class='hs-varid'>findFirst</span> <span class='hs-varid'>p</span> <span class='hs-layout'>(</span><span class='hs-varid'>x</span><span class='hs-conop'>:</span><span class='hs-varid'>xs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fmap</span> <span class='hs-layout'>(</span><span class='hs-varid'>id</span> <span class='hs-varop'>***</span> <span class='hs-layout'>(</span><span class='hs-varid'>x</span><span class='hs-conop'>:</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>findFirst</span> <span class='hs-varid'>p</span> <span class='hs-varid'>xs</span><span class='hs-layout'>)</span>
<a name="line-147"></a>
<a name="line-148"></a><a name="groupLens"></a><span class='hs-definition'>groupLens</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>BiGUL</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>Int</span><span class='hs-layout'>,</span><span class='hs-conid'>Int</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>Int</span> <span class='hs-layout'>,</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>Int</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-149"></a><span class='hs-definition'>groupLens</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>align</span> <span class='hs-layout'>(</span><span class='hs-varid'>const</span> <span class='hs-conid'>True</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>x</span> <span class='hs-varid'>y</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>x</span> <span class='hs-varop'>==</span> <span class='hs-varid'>y</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>Replace</span><span class='hs-layout'>)</span> <span class='hs-varid'>id</span> <span class='hs-layout'>(</span><span class='hs-varid'>const</span> <span class='hs-conid'>Nothing</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varop'>`Compose`</span> <span class='hs-layout'>(</span><span class='hs-varid'>expandLens</span> <span class='hs-conid'>True</span><span class='hs-layout'>)</span>
<a name="line-150"></a>
<a name="line-151"></a><a name="sortLens"></a><span class='hs-comment'>-- | A lens whose get-direction is 'sort'. This implementation has an O(n^2) time complexity.</span>
<a name="line-152"></a><span class='hs-definition'>sortLens</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>Show</span> <span class='hs-varid'>a</span><span class='hs-layout'>,</span> <span class='hs-conid'>Ord</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>BiGUL</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>a</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>a</span><span class='hs-keyglyph'>]</span>
<a name="line-153"></a><span class='hs-definition'>sortLens</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Case</span> 
<a name="line-154"></a>    <span class='hs-keyglyph'>[</span> <span class='hs-varop'>$</span><span class='hs-layout'>(</span><span class='hs-varid'>normalSV</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>p</span><span class='hs-keyglyph'>|</span> <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>|</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>p</span><span class='hs-keyglyph'>|</span> <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>|</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>p</span><span class='hs-keyglyph'>|</span> <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>|</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span> 
<a name="line-155"></a>      <span class='hs-varop'>==&gt;</span> <span class='hs-conid'>Skip</span> <span class='hs-layout'>(</span><span class='hs-varid'>const</span> <span class='hs-conid'>[]</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-156"></a>
<a name="line-157"></a>      <span class='hs-varop'>$</span><span class='hs-layout'>(</span><span class='hs-varid'>adaptiveSV</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>p</span><span class='hs-keyglyph'>|</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>|</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>p</span><span class='hs-keyglyph'>|</span> <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>|</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-158"></a>      <span class='hs-varop'>==&gt;</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>s</span> <span class='hs-varid'>v</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>[]</span><span class='hs-layout'>,</span>
<a name="line-159"></a>
<a name="line-160"></a>      <span class='hs-varop'>$</span><span class='hs-layout'>(</span><span class='hs-varid'>normalSV</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>p</span><span class='hs-keyglyph'>|</span> <span class='hs-varid'>s</span><span class='hs-conop'>:</span><span class='hs-varid'>ss</span> <span class='hs-keyglyph'>|</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>p</span><span class='hs-keyglyph'>|</span> <span class='hs-varid'>v</span><span class='hs-conop'>:</span><span class='hs-varid'>vs</span> <span class='hs-keyglyph'>|</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>p</span><span class='hs-keyglyph'>|</span> <span class='hs-varid'>s</span><span class='hs-conop'>:</span><span class='hs-varid'>ss</span> <span class='hs-keyglyph'>|</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-161"></a>      <span class='hs-varop'>==&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>findMinLens</span> <span class='hs-varop'>`Compose`</span> <span class='hs-varop'>$</span><span class='hs-layout'>(</span><span class='hs-varid'>update</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>p</span><span class='hs-keyglyph'>|</span> <span class='hs-varid'>s</span><span class='hs-conop'>:</span><span class='hs-varid'>ss</span> <span class='hs-keyglyph'>|</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>p</span><span class='hs-keyglyph'>|</span> <span class='hs-varid'>s</span><span class='hs-conop'>:</span><span class='hs-varid'>ss</span> <span class='hs-keyglyph'>|</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>d</span><span class='hs-keyglyph'>|</span> <span class='hs-varid'>s</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Replace</span><span class='hs-layout'>;</span> <span class='hs-varid'>ss</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sortLens</span> <span class='hs-keyglyph'>|</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-162"></a>
<a name="line-163"></a>      <span class='hs-varop'>$</span><span class='hs-layout'>(</span><span class='hs-varid'>adaptiveSV</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>p</span><span class='hs-keyglyph'>|</span> <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>|</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>p</span><span class='hs-keyglyph'>|</span> <span class='hs-varid'>v</span><span class='hs-conop'>:</span><span class='hs-varid'>vs</span> <span class='hs-keyglyph'>|</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-164"></a>      <span class='hs-varop'>==&gt;</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>s</span> <span class='hs-varid'>v</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>v</span>
<a name="line-165"></a>    <span class='hs-keyglyph'>]</span>
<a name="line-166"></a>
<a name="line-167"></a><a name="findMinLens"></a><span class='hs-comment'>-- | A lens which rearranges the minimum as the first element.</span>
<a name="line-168"></a><span class='hs-definition'>findMinLens</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>Show</span> <span class='hs-varid'>a</span><span class='hs-layout'>,</span> <span class='hs-conid'>Ord</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>BiGUL</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>a</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>a</span><span class='hs-keyglyph'>]</span>
<a name="line-169"></a><span class='hs-definition'>findMinLens</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>findMinRearr</span> <span class='hs-varop'>`Compose`</span> <span class='hs-varid'>reassemble</span>
<a name="line-170"></a>    <span class='hs-keyword'>where</span> <span class='hs-varid'>findMinRearr</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>Show</span> <span class='hs-varid'>a</span><span class='hs-layout'>,</span> <span class='hs-conid'>Ord</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>BiGUL</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>a</span><span class='hs-keyglyph'>]</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span><span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-varid'>a</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>a</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-171"></a>          <span class='hs-varid'>findMinRearr</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Case</span>
<a name="line-172"></a>              <span class='hs-keyglyph'>[</span> <span class='hs-varop'>$</span><span class='hs-layout'>(</span><span class='hs-varid'>normal</span> <span class='hs-keyglyph'>[</span><span class='hs-keyglyph'>|</span> <span class='hs-keyglyph'>\</span><span class='hs-layout'>(</span><span class='hs-varid'>s</span><span class='hs-conop'>:</span><span class='hs-varid'>ss</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>v</span><span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-conid'>[]</span><span class='hs-layout'>,</span> <span class='hs-varid'>vs</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>s</span> <span class='hs-varop'>==</span> <span class='hs-varid'>minimum</span> <span class='hs-layout'>(</span><span class='hs-varid'>s</span><span class='hs-conop'>:</span><span class='hs-varid'>ss</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span><span class='hs-keyglyph'>]</span>
<a name="line-173"></a>                         <span class='hs-keyglyph'>[</span><span class='hs-keyglyph'>|</span> <span class='hs-keyglyph'>\</span><span class='hs-layout'>(</span><span class='hs-varid'>s</span><span class='hs-conop'>:</span><span class='hs-varid'>ss</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>s</span> <span class='hs-varop'>==</span> <span class='hs-varid'>minimum</span> <span class='hs-layout'>(</span><span class='hs-varid'>s</span><span class='hs-conop'>:</span><span class='hs-varid'>ss</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-174"></a>                <span class='hs-varop'>==&gt;</span> <span class='hs-varop'>$</span><span class='hs-layout'>(</span><span class='hs-varid'>update</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>p</span><span class='hs-keyglyph'>|</span> <span class='hs-varid'>s</span><span class='hs-conop'>:</span><span class='hs-varid'>ss</span> <span class='hs-keyglyph'>|</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>p</span><span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-varid'>s</span><span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-conid'>[]</span><span class='hs-layout'>,</span> <span class='hs-varid'>ss</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span><span class='hs-keyglyph'>]</span>
<a name="line-175"></a>                             <span class='hs-keyglyph'>[</span><span class='hs-varid'>d</span><span class='hs-keyglyph'>|</span> <span class='hs-varid'>s</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Replace</span><span class='hs-layout'>;</span> <span class='hs-varid'>ss</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Replace</span> <span class='hs-keyglyph'>|</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-176"></a>
<a name="line-177"></a>                <span class='hs-varop'>$</span><span class='hs-layout'>(</span><span class='hs-varid'>adaptive</span> <span class='hs-keyglyph'>[</span><span class='hs-keyglyph'>|</span> <span class='hs-keyglyph'>\</span><span class='hs-layout'>(</span><span class='hs-varid'>s</span><span class='hs-conop'>:</span><span class='hs-varid'>ss</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-varid'>p</span><span class='hs-conop'>:</span><span class='hs-varid'>ps</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>s</span> <span class='hs-varop'>==</span> <span class='hs-varid'>minimum</span> <span class='hs-layout'>(</span><span class='hs-varid'>s</span><span class='hs-conop'>:</span><span class='hs-varid'>ss</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-178"></a>                <span class='hs-varop'>==&gt;</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>s</span> <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-varid'>p</span><span class='hs-conop'>:</span><span class='hs-varid'>ps</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>p</span><span class='hs-conop'>:</span><span class='hs-varid'>s</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-179"></a>
<a name="line-180"></a>                <span class='hs-varop'>$</span><span class='hs-layout'>(</span><span class='hs-varid'>adaptive</span> <span class='hs-keyglyph'>[</span><span class='hs-keyglyph'>|</span> <span class='hs-keyglyph'>\</span><span class='hs-layout'>(</span><span class='hs-varid'>s</span><span class='hs-conop'>:</span><span class='hs-varid'>ss</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-conid'>[]</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span> <span class='hs-keyglyph'>|</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-181"></a>                <span class='hs-varop'>==&gt;</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>s</span> <span class='hs-varid'>v</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>dropWhile</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>k</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>k</span> <span class='hs-varop'>/=</span> <span class='hs-varid'>minimum</span> <span class='hs-varid'>s</span><span class='hs-layout'>)</span> <span class='hs-varid'>s</span><span class='hs-layout'>,</span>
<a name="line-182"></a>
<a name="line-183"></a>                <span class='hs-varop'>$</span><span class='hs-layout'>(</span><span class='hs-varid'>normal</span> <span class='hs-keyglyph'>[</span><span class='hs-keyglyph'>|</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>s</span> <span class='hs-varid'>v</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span> <span class='hs-keyglyph'>|</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>[</span><span class='hs-keyglyph'>|</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>s</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span> <span class='hs-keyglyph'>|</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-184"></a>                <span class='hs-varop'>==&gt;</span> <span class='hs-varop'>$</span><span class='hs-layout'>(</span><span class='hs-varid'>rearrV</span> <span class='hs-keyglyph'>[</span><span class='hs-keyglyph'>|</span> <span class='hs-keyglyph'>\</span><span class='hs-layout'>(</span><span class='hs-varid'>v</span><span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-varid'>p</span><span class='hs-conop'>:</span><span class='hs-varid'>ps</span><span class='hs-layout'>,</span> <span class='hs-varid'>vs</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>p</span><span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-varid'>v</span><span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-varid'>ps</span><span class='hs-layout'>,</span> <span class='hs-varid'>vs</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-185"></a>                    <span class='hs-varop'>$</span><span class='hs-layout'>(</span><span class='hs-varid'>update</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>p</span><span class='hs-keyglyph'>|</span> <span class='hs-varid'>s</span><span class='hs-conop'>:</span><span class='hs-varid'>ss</span> <span class='hs-keyglyph'>|</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>p</span><span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-varid'>s</span><span class='hs-layout'>,</span> <span class='hs-varid'>ss</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span><span class='hs-keyglyph'>]</span>
<a name="line-186"></a>                             <span class='hs-keyglyph'>[</span><span class='hs-varid'>d</span><span class='hs-keyglyph'>|</span> <span class='hs-varid'>s</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Replace</span><span class='hs-layout'>;</span> <span class='hs-varid'>ss</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>findMinRearr</span> <span class='hs-keyglyph'>|</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-187"></a>              <span class='hs-keyglyph'>]</span>
<a name="line-188"></a>
<a name="line-189"></a>          <span class='hs-varid'>reassemble</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>Show</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>BiGUL</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span><span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-varid'>a</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>a</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>a</span><span class='hs-keyglyph'>]</span>
<a name="line-190"></a>          <span class='hs-varid'>reassemble</span> <span class='hs-keyglyph'>=</span> <span class='hs-varop'>$</span><span class='hs-layout'>(</span><span class='hs-varid'>update</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>p</span><span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-varid'>s</span><span class='hs-layout'>,</span> <span class='hs-varid'>ss</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>p</span><span class='hs-keyglyph'>|</span> <span class='hs-varid'>s</span><span class='hs-conop'>:</span><span class='hs-varid'>ss</span> <span class='hs-keyglyph'>|</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>d</span><span class='hs-keyglyph'>|</span> <span class='hs-varid'>s</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Replace</span><span class='hs-layout'>;</span> <span class='hs-varid'>ss</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>appendLens</span> <span class='hs-keyglyph'>|</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-191"></a>
<a name="line-192"></a><a name="appendLens"></a><span class='hs-comment'>-- | A lens which appends two lists. For the put-direction, it updates each element in the first </span>
<a name="line-193"></a><span class='hs-comment'>-- list of the source first and then uses the rest of the view to update the second list.</span>
<a name="line-194"></a><span class='hs-definition'>appendLens</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>Show</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>BiGUL</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-varid'>a</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>a</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>a</span><span class='hs-keyglyph'>]</span>
<a name="line-195"></a><span class='hs-definition'>appendLens</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Case</span> <span class='hs-keyglyph'>[</span>
<a name="line-196"></a>    <span class='hs-varop'>$</span><span class='hs-layout'>(</span><span class='hs-varid'>normalSV</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>p</span><span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-conid'>[]</span><span class='hs-layout'>,</span><span class='hs-conid'>[]</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>p</span><span class='hs-keyglyph'>|</span> <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>|</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>p</span><span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-conid'>[]</span><span class='hs-layout'>,</span><span class='hs-conid'>[]</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-197"></a>    <span class='hs-varop'>==&gt;</span> <span class='hs-varop'>$</span><span class='hs-layout'>(</span><span class='hs-varid'>rearrV</span> <span class='hs-keyglyph'>[</span><span class='hs-keyglyph'>|</span> <span class='hs-keyglyph'>\</span><span class='hs-conid'>[]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>()</span> <span class='hs-keyglyph'>|</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>Skip</span> <span class='hs-layout'>(</span><span class='hs-varid'>const</span> <span class='hs-conid'>()</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-198"></a>
<a name="line-199"></a>    <span class='hs-varop'>$</span><span class='hs-layout'>(</span><span class='hs-varid'>adaptiveSV</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>p</span><span class='hs-keyglyph'>|</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>|</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>p</span><span class='hs-keyglyph'>|</span> <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>|</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-200"></a>    <span class='hs-varop'>==&gt;</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>s</span> <span class='hs-varid'>v</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>[]</span><span class='hs-layout'>,</span> <span class='hs-conid'>[]</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-201"></a>
<a name="line-202"></a>    <span class='hs-varop'>$</span><span class='hs-layout'>(</span><span class='hs-varid'>normalSV</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>p</span><span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span><span class='hs-conop'>:</span><span class='hs-keyword'>as</span><span class='hs-layout'>,</span><span class='hs-varid'>b</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>p</span><span class='hs-keyglyph'>|</span> <span class='hs-varid'>v</span><span class='hs-conop'>:</span><span class='hs-varid'>vs</span> <span class='hs-keyglyph'>|</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>p</span><span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span><span class='hs-conop'>:</span><span class='hs-keyword'>as</span><span class='hs-layout'>,</span><span class='hs-varid'>b</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-203"></a>    <span class='hs-varop'>==&gt;</span> <span class='hs-varop'>$</span><span class='hs-layout'>(</span><span class='hs-varid'>rearrS</span> <span class='hs-keyglyph'>[</span><span class='hs-keyglyph'>|</span> <span class='hs-keyglyph'>\</span><span class='hs-layout'>(</span><span class='hs-varid'>a</span><span class='hs-conop'>:</span><span class='hs-keyword'>as</span><span class='hs-layout'>,</span><span class='hs-varid'>b</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span><span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-keyword'>as</span><span class='hs-layout'>,</span><span class='hs-varid'>b</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-204"></a>        <span class='hs-varop'>$</span><span class='hs-layout'>(</span><span class='hs-varid'>update</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>p</span><span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span><span class='hs-layout'>,</span> <span class='hs-varid'>rest</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>p</span><span class='hs-keyglyph'>|</span> <span class='hs-varid'>a</span><span class='hs-conop'>:</span><span class='hs-varid'>rest</span> <span class='hs-keyglyph'>|</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>d</span><span class='hs-keyglyph'>|</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Replace</span><span class='hs-layout'>;</span> <span class='hs-varid'>rest</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>appendLens</span> <span class='hs-keyglyph'>|</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-205"></a>
<a name="line-206"></a>    <span class='hs-varop'>$</span><span class='hs-layout'>(</span><span class='hs-varid'>normalSV</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>p</span><span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-conid'>[]</span><span class='hs-layout'>,</span><span class='hs-varid'>b</span><span class='hs-conop'>:</span><span class='hs-varid'>bs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>p</span><span class='hs-keyglyph'>|</span> <span class='hs-varid'>v</span><span class='hs-conop'>:</span><span class='hs-varid'>vs</span> <span class='hs-keyglyph'>|</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>p</span><span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-conid'>[]</span><span class='hs-layout'>,</span><span class='hs-varid'>b</span><span class='hs-conop'>:</span><span class='hs-varid'>bs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-207"></a>    <span class='hs-varop'>==&gt;</span> <span class='hs-varop'>$</span><span class='hs-layout'>(</span><span class='hs-varid'>rearrS</span> <span class='hs-keyglyph'>[</span><span class='hs-keyglyph'>|</span> <span class='hs-keyglyph'>\</span><span class='hs-layout'>(</span><span class='hs-conid'>[]</span><span class='hs-layout'>,</span><span class='hs-varid'>b</span><span class='hs-conop'>:</span><span class='hs-varid'>bs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>b</span><span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-conid'>[]</span><span class='hs-layout'>,</span><span class='hs-varid'>bs</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-208"></a>        <span class='hs-varop'>$</span><span class='hs-layout'>(</span><span class='hs-varid'>update</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>p</span><span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span><span class='hs-layout'>,</span> <span class='hs-varid'>rest</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>p</span><span class='hs-keyglyph'>|</span> <span class='hs-varid'>a</span><span class='hs-conop'>:</span><span class='hs-varid'>rest</span> <span class='hs-keyglyph'>|</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>d</span><span class='hs-keyglyph'>|</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Replace</span><span class='hs-layout'>;</span> <span class='hs-varid'>rest</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>appendLens</span> <span class='hs-keyglyph'>|</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-209"></a>
<a name="line-210"></a>    <span class='hs-varop'>$</span><span class='hs-layout'>(</span><span class='hs-varid'>adaptiveSV</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>p</span><span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-conid'>[]</span><span class='hs-layout'>,</span><span class='hs-conid'>[]</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>p</span><span class='hs-keyglyph'>|</span> <span class='hs-varid'>v</span><span class='hs-conop'>:</span><span class='hs-varid'>vs</span> <span class='hs-keyglyph'>|</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-211"></a>    <span class='hs-varop'>==&gt;</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>s</span> <span class='hs-varid'>v</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>[]</span><span class='hs-layout'>,</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span>
<a name="line-212"></a>    <span class='hs-keyglyph'>]</span>
<a name="line-213"></a>
<a name="line-214"></a><a name="filterLens'"></a><span class='hs-definition'>filterLens'</span> <span class='hs-varid'>p</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emb</span> <span class='hs-layout'>(</span><span class='hs-varid'>filter</span> <span class='hs-varid'>p</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>filterPut</span> <span class='hs-varid'>p</span><span class='hs-layout'>)</span>
<a name="line-215"></a><a name="filterPut"></a><span class='hs-definition'>filterPut</span> <span class='hs-varid'>p</span> <span class='hs-varid'>s</span> <span class='hs-varid'>v</span> <span class='hs-keyglyph'>=</span> 
<a name="line-216"></a>    <span class='hs-keyword'>if</span> <span class='hs-varid'>null</span> <span class='hs-layout'>(</span><span class='hs-varid'>filter</span> <span class='hs-layout'>(</span><span class='hs-varid'>not</span> <span class='hs-varop'>.</span> <span class='hs-varid'>p</span><span class='hs-layout'>)</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span> 
<a name="line-217"></a>       <span class='hs-keyword'>then</span> <span class='hs-varid'>filterPut'</span> <span class='hs-varid'>s</span> <span class='hs-varid'>v</span>
<a name="line-218"></a>       <span class='hs-keyword'>else</span> <span class='hs-layout'>(</span><span class='hs-varid'>error</span> <span class='hs-str'>"filterLens: invalid view"</span><span class='hs-layout'>)</span>
<a name="line-219"></a>    <span class='hs-keyword'>where</span> <span class='hs-varid'>filterPut'</span> <span class='hs-varid'>s</span> <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>filter</span> <span class='hs-layout'>(</span><span class='hs-varid'>not</span> <span class='hs-varop'>.</span> <span class='hs-varid'>p</span><span class='hs-layout'>)</span> <span class='hs-varid'>s</span>
<a name="line-220"></a>          <span class='hs-varid'>filterPut'</span> <span class='hs-conid'>[]</span> <span class='hs-varid'>v</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>v</span>
<a name="line-221"></a>          <span class='hs-varid'>filterPut'</span> <span class='hs-layout'>(</span><span class='hs-varid'>s</span><span class='hs-conop'>:</span><span class='hs-varid'>ss</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>v</span><span class='hs-conop'>:</span><span class='hs-varid'>vs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>p</span> <span class='hs-varid'>s</span><span class='hs-layout'>)</span> <span class='hs-keyword'>then</span> <span class='hs-varid'>s</span> <span class='hs-conop'>:</span> <span class='hs-layout'>(</span><span class='hs-varid'>filterPut'</span> <span class='hs-varid'>ss</span> <span class='hs-layout'>(</span><span class='hs-varid'>v</span><span class='hs-conop'>:</span><span class='hs-varid'>vs</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyword'>else</span> <span class='hs-layout'>(</span><span class='hs-varid'>v</span> <span class='hs-conop'>:</span> <span class='hs-varid'>filterPut'</span> <span class='hs-varid'>ss</span> <span class='hs-varid'>vs</span><span class='hs-layout'>)</span>
<a name="line-222"></a>
<a name="line-223"></a><a name="bx1"></a><span class='hs-definition'>bx1</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>BiGUL</span> <span class='hs-layout'>(</span><span class='hs-conid'>Int</span><span class='hs-layout'>,</span> <span class='hs-conid'>String</span><span class='hs-layout'>)</span> <span class='hs-conid'>Int</span>
<a name="line-224"></a><span class='hs-definition'>bx1</span> <span class='hs-keyglyph'>=</span> <span class='hs-varop'>$</span><span class='hs-layout'>(</span><span class='hs-varid'>update</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>p</span><span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-varid'>x</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>p</span><span class='hs-keyglyph'>|</span> <span class='hs-varid'>x</span> <span class='hs-keyglyph'>|</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>d</span><span class='hs-keyglyph'>|</span> <span class='hs-varid'>x</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Replace</span> <span class='hs-keyglyph'>|</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-225"></a>
<a name="line-226"></a><a name="minEditDistLens"></a><span class='hs-definition'>minEditDistLens</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>Show</span> <span class='hs-varid'>s</span><span class='hs-layout'>,</span> <span class='hs-conid'>Show</span> <span class='hs-varid'>v</span><span class='hs-layout'>,</span> <span class='hs-conid'>Eq</span> <span class='hs-varid'>s</span><span class='hs-layout'>,</span> <span class='hs-conid'>Eq</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>BiGUL</span> <span class='hs-varid'>s</span> <span class='hs-varid'>v</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>v</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>s</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>BiGUL</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>s</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>v</span><span class='hs-keyglyph'>]</span>
<a name="line-227"></a><span class='hs-definition'>minEditDistLens</span> <span class='hs-varid'>bx</span> <span class='hs-varid'>create</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Case</span>
<a name="line-228"></a>    <span class='hs-comment'>-- 'bx' tries to update from view to source by simply replacing elements in source and view one by one,</span>
<a name="line-229"></a>    <span class='hs-comment'>-- If it is not the most efficient way, we try to add elements or delete elements.</span>
<a name="line-230"></a>    <span class='hs-keyglyph'>[</span> <span class='hs-varop'>$</span><span class='hs-layout'>(</span><span class='hs-varid'>adaptive</span> <span class='hs-keyglyph'>[</span><span class='hs-keyglyph'>|</span> <span class='hs-keyglyph'>\</span> <span class='hs-varid'>s</span> <span class='hs-varid'>v</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>length</span> <span class='hs-varid'>s</span> <span class='hs-varop'>/=</span> <span class='hs-varid'>length</span> <span class='hs-varid'>v</span> <span class='hs-varop'>||</span> <span class='hs-varid'>structureEdit</span> <span class='hs-varid'>bx</span> <span class='hs-varid'>create</span> <span class='hs-varid'>s</span> <span class='hs-varid'>v</span> <span class='hs-varop'>/=</span> <span class='hs-varid'>s</span> <span class='hs-keyglyph'>|</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-231"></a>      <span class='hs-varop'>==&gt;</span> <span class='hs-varid'>structureEdit</span> <span class='hs-varid'>bx</span> <span class='hs-varid'>create</span>
<a name="line-232"></a>    <span class='hs-layout'>,</span>
<a name="line-233"></a>     <span class='hs-varop'>$</span><span class='hs-layout'>(</span><span class='hs-varid'>normalSV</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>p</span><span class='hs-keyglyph'>|</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>|</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>p</span><span class='hs-keyglyph'>|</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>|</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>p</span><span class='hs-keyglyph'>|</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>|</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-234"></a>      <span class='hs-varop'>==&gt;</span> <span class='hs-varid'>mapLens</span> <span class='hs-varid'>bx</span> <span class='hs-varid'>create</span>
<a name="line-235"></a>    <span class='hs-keyglyph'>]</span>
<a name="line-236"></a>
<a name="line-237"></a><a name="Operation"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>Operation</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>OpModify</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>OpInsert</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>OpDelete</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>OpNothing</span> <span class='hs-keyword'>deriving</span> <span class='hs-layout'>(</span><span class='hs-conid'>Show</span><span class='hs-layout'>,</span> <span class='hs-conid'>Eq</span><span class='hs-layout'>,</span> <span class='hs-conid'>Ord</span><span class='hs-layout'>)</span>
<a name="line-238"></a>
<a name="line-239"></a><a name="minEditDistDP"></a><span class='hs-definition'>minEditDistDP</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>Eq</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>a</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>a</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Array</span> <span class='hs-layout'>(</span><span class='hs-conid'>Int</span><span class='hs-layout'>,</span> <span class='hs-conid'>Int</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>Int</span><span class='hs-layout'>,</span> <span class='hs-conid'>Operation</span><span class='hs-layout'>)</span>
<a name="line-240"></a><span class='hs-definition'>minEditDistDP</span> <span class='hs-varid'>s</span> <span class='hs-varid'>v</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>runST</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-241"></a>    <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>lenS</span><span class='hs-layout'>,</span> <span class='hs-varid'>lenV</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>length</span> <span class='hs-varid'>s</span><span class='hs-layout'>,</span> <span class='hs-varid'>length</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span>
<a name="line-242"></a>    <span class='hs-varid'>arrS</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newSTListArray</span> <span class='hs-layout'>(</span><span class='hs-num'>1</span><span class='hs-layout'>,</span> <span class='hs-varid'>lenS</span><span class='hs-layout'>)</span> <span class='hs-varid'>s</span>
<a name="line-243"></a>    <span class='hs-varid'>arrV</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newSTListArray</span> <span class='hs-layout'>(</span><span class='hs-num'>1</span><span class='hs-layout'>,</span> <span class='hs-varid'>lenV</span><span class='hs-layout'>)</span> <span class='hs-varid'>v</span>
<a name="line-244"></a>    <span class='hs-varid'>f</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newArray</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-num'>0</span><span class='hs-layout'>,</span><span class='hs-num'>0</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-varid'>lenS</span><span class='hs-layout'>,</span> <span class='hs-varid'>lenV</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-comment'>-</span><span class='hs-num'>1</span><span class='hs-layout'>,</span> <span class='hs-conid'>OpInsert</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ST</span> <span class='hs-varid'>s</span> <span class='hs-layout'>(</span><span class='hs-conid'>STArray</span> <span class='hs-varid'>s</span> <span class='hs-layout'>(</span><span class='hs-conid'>Int</span><span class='hs-layout'>,</span> <span class='hs-conid'>Int</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>Int</span><span class='hs-layout'>,</span> <span class='hs-conid'>Operation</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-245"></a>    <span class='hs-varid'>forM_</span> <span class='hs-keyglyph'>[</span><span class='hs-num'>0</span> <span class='hs-keyglyph'>..</span> <span class='hs-varid'>lenV</span><span class='hs-keyglyph'>]</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>i</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>writeArray</span> <span class='hs-varid'>f</span> <span class='hs-layout'>(</span><span class='hs-num'>0</span><span class='hs-layout'>,</span> <span class='hs-varid'>i</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>i</span><span class='hs-layout'>,</span> <span class='hs-conid'>OpInsert</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-246"></a>    <span class='hs-varid'>forM_</span> <span class='hs-keyglyph'>[</span><span class='hs-num'>0</span> <span class='hs-keyglyph'>..</span> <span class='hs-varid'>lenS</span><span class='hs-keyglyph'>]</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>i</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>writeArray</span> <span class='hs-varid'>f</span> <span class='hs-layout'>(</span><span class='hs-varid'>i</span><span class='hs-layout'>,</span> <span class='hs-num'>0</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>i</span><span class='hs-layout'>,</span> <span class='hs-conid'>OpDelete</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-247"></a>    <span class='hs-varid'>writeArray</span> <span class='hs-varid'>f</span> <span class='hs-layout'>(</span><span class='hs-num'>0</span><span class='hs-layout'>,</span><span class='hs-num'>0</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-num'>0</span><span class='hs-layout'>,</span> <span class='hs-conid'>OpNothing</span><span class='hs-layout'>)</span>
<a name="line-248"></a>    <span class='hs-varid'>forM_</span> <span class='hs-layout'>(</span><span class='hs-varid'>range</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-num'>1</span><span class='hs-layout'>,</span><span class='hs-num'>1</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-varid'>lenS</span><span class='hs-layout'>,</span> <span class='hs-varid'>lenV</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-layout'>(</span><span class='hs-varid'>i</span><span class='hs-layout'>,</span> <span class='hs-varid'>j</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-249"></a>        <span class='hs-varid'>si</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>readArray</span> <span class='hs-varid'>arrS</span> <span class='hs-varid'>i</span>
<a name="line-250"></a>        <span class='hs-varid'>sj</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>readArray</span> <span class='hs-varid'>arrV</span> <span class='hs-varid'>j</span>
<a name="line-251"></a>        <span class='hs-keyword'>if</span> <span class='hs-varid'>si</span> <span class='hs-varop'>==</span> <span class='hs-varid'>sj</span> 
<a name="line-252"></a>           <span class='hs-keyword'>then</span> <span class='hs-varid'>readArray</span> <span class='hs-varid'>f</span> <span class='hs-layout'>(</span><span class='hs-varid'>i</span><span class='hs-comment'>-</span><span class='hs-num'>1</span><span class='hs-layout'>,</span> <span class='hs-varid'>j</span><span class='hs-comment'>-</span><span class='hs-num'>1</span><span class='hs-layout'>)</span> <span class='hs-varop'>&gt;&gt;=</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>p</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>writeArray</span> <span class='hs-varid'>f</span> <span class='hs-layout'>(</span><span class='hs-varid'>i</span><span class='hs-layout'>,</span> <span class='hs-varid'>j</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>modifySnd</span> <span class='hs-conid'>OpNothing</span> <span class='hs-varid'>p</span><span class='hs-layout'>)</span>
<a name="line-253"></a>           <span class='hs-keyword'>else</span> <span class='hs-keyword'>do</span>
<a name="line-254"></a>               <span class='hs-varid'>cModify</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>readArray</span> <span class='hs-varid'>f</span> <span class='hs-layout'>(</span><span class='hs-varid'>i</span><span class='hs-comment'>-</span><span class='hs-num'>1</span><span class='hs-layout'>,</span> <span class='hs-varid'>j</span><span class='hs-comment'>-</span><span class='hs-num'>1</span><span class='hs-layout'>)</span>
<a name="line-255"></a>               <span class='hs-varid'>cInsert</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>readArray</span> <span class='hs-varid'>f</span> <span class='hs-layout'>(</span><span class='hs-varid'>i</span><span class='hs-layout'>,</span> <span class='hs-varid'>j</span><span class='hs-comment'>-</span><span class='hs-num'>1</span><span class='hs-layout'>)</span>
<a name="line-256"></a>               <span class='hs-varid'>cDelete</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>readArray</span> <span class='hs-varid'>f</span> <span class='hs-layout'>(</span><span class='hs-varid'>i</span><span class='hs-comment'>-</span><span class='hs-num'>1</span><span class='hs-layout'>,</span> <span class='hs-varid'>j</span><span class='hs-layout'>)</span>
<a name="line-257"></a>               <span class='hs-varid'>writeArray</span> <span class='hs-varid'>f</span> <span class='hs-layout'>(</span><span class='hs-varid'>i</span><span class='hs-layout'>,</span> <span class='hs-varid'>j</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-layout'>(</span><span class='hs-varid'>x</span><span class='hs-layout'>,</span> <span class='hs-varid'>y</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>x</span><span class='hs-varop'>+</span><span class='hs-num'>1</span><span class='hs-layout'>,</span> <span class='hs-varid'>y</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>minimum</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>modifySnd</span> <span class='hs-conid'>OpModify</span> <span class='hs-varid'>cModify</span><span class='hs-layout'>,</span>
<a name="line-258"></a>                                                                     <span class='hs-varid'>modifySnd</span> <span class='hs-conid'>OpInsert</span> <span class='hs-varid'>cInsert</span><span class='hs-layout'>,</span>
<a name="line-259"></a>                                                                     <span class='hs-varid'>modifySnd</span> <span class='hs-conid'>OpDelete</span> <span class='hs-varid'>cDelete</span> <span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span> <span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-260"></a>    <span class='hs-varid'>freeze</span> <span class='hs-varid'>f</span>
<a name="line-261"></a>    <span class='hs-keyword'>where</span> <span class='hs-varid'>newSTListArray</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>Ix</span> <span class='hs-varid'>i</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>i</span><span class='hs-layout'>,</span><span class='hs-varid'>i</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>a</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ST</span> <span class='hs-varid'>s</span> <span class='hs-layout'>(</span><span class='hs-conid'>STArray</span> <span class='hs-varid'>s</span> <span class='hs-varid'>i</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-262"></a>          <span class='hs-varid'>newSTListArray</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>newListArray</span>
<a name="line-263"></a>          <span class='hs-varid'>modifySnd</span> <span class='hs-varid'>x</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span><span class='hs-layout'>,</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span><span class='hs-layout'>,</span> <span class='hs-varid'>x</span><span class='hs-layout'>)</span>
<a name="line-264"></a>
<a name="line-265"></a><a name="structureEdit"></a><span class='hs-definition'>structureEdit</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>Show</span> <span class='hs-varid'>s</span><span class='hs-layout'>,</span> <span class='hs-conid'>Show</span> <span class='hs-varid'>v</span><span class='hs-layout'>,</span> <span class='hs-conid'>Eq</span> <span class='hs-varid'>s</span><span class='hs-layout'>,</span> <span class='hs-conid'>Eq</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>BiGUL</span> <span class='hs-varid'>s</span> <span class='hs-varid'>v</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>v</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>s</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>s</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>v</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>s</span><span class='hs-keyglyph'>]</span>
<a name="line-266"></a><span class='hs-definition'>structureEdit</span> <span class='hs-varid'>bx</span> <span class='hs-varid'>create</span> <span class='hs-varid'>s</span> <span class='hs-varid'>v</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>sv</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>get</span> <span class='hs-layout'>(</span><span class='hs-varid'>mapLens</span> <span class='hs-varid'>bx</span> <span class='hs-varid'>create</span><span class='hs-layout'>)</span> <span class='hs-varid'>s</span>
<a name="line-267"></a>                              <span class='hs-keyword'>in</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>sv</span> <span class='hs-varop'>==</span> <span class='hs-conid'>Nothing</span> 
<a name="line-268"></a>                                    <span class='hs-keyword'>then</span> <span class='hs-varid'>s</span>
<a name="line-269"></a>                                    <span class='hs-keyword'>else</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>f</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>minEditDistDP</span> <span class='hs-layout'>(</span><span class='hs-varid'>fromJust</span> <span class='hs-varid'>sv</span><span class='hs-layout'>)</span> <span class='hs-varid'>v</span>
<a name="line-270"></a>                                             <span class='hs-varid'>reconstruct</span> <span class='hs-num'>0</span> <span class='hs-num'>0</span> <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span>
<a name="line-271"></a>                                             <span class='hs-varid'>reconstruct</span> <span class='hs-varid'>i</span> <span class='hs-varid'>j</span> <span class='hs-varid'>s</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>snd</span> <span class='hs-layout'>(</span><span class='hs-varid'>f</span> <span class='hs-varop'>!</span> <span class='hs-layout'>(</span><span class='hs-varid'>i</span><span class='hs-layout'>,</span><span class='hs-varid'>j</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span>
<a name="line-272"></a>                                                 <span class='hs-conid'>OpNothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>head</span> <span class='hs-varid'>s</span> <span class='hs-conop'>:</span> <span class='hs-varid'>reconstruct</span> <span class='hs-layout'>(</span><span class='hs-varid'>i</span><span class='hs-comment'>-</span><span class='hs-num'>1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>j</span><span class='hs-comment'>-</span><span class='hs-num'>1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>tail</span> <span class='hs-varid'>s</span><span class='hs-layout'>)</span>
<a name="line-273"></a>                                                 <span class='hs-conid'>OpModify</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>head</span> <span class='hs-varid'>s</span> <span class='hs-conop'>:</span> <span class='hs-varid'>reconstruct</span> <span class='hs-layout'>(</span><span class='hs-varid'>i</span><span class='hs-comment'>-</span><span class='hs-num'>1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>j</span><span class='hs-comment'>-</span><span class='hs-num'>1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>tail</span> <span class='hs-varid'>s</span><span class='hs-layout'>)</span>
<a name="line-274"></a>                                                 <span class='hs-conid'>OpInsert</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>create</span> <span class='hs-layout'>(</span><span class='hs-varid'>head</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span> <span class='hs-conop'>:</span> <span class='hs-varid'>reconstruct</span> <span class='hs-varid'>i</span> <span class='hs-layout'>(</span><span class='hs-varid'>j</span><span class='hs-comment'>-</span><span class='hs-num'>1</span><span class='hs-layout'>)</span> <span class='hs-varid'>s</span>
<a name="line-275"></a>                                                 <span class='hs-comment'>-- FIXME: the following maybe more safe</span>
<a name="line-276"></a>                                                 <span class='hs-comment'>-- OpInsert -&gt; fromJust (put bx (create v) v) : reconstruct i (j-1) s</span>
<a name="line-277"></a>                                                 <span class='hs-conid'>OpDelete</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>reconstruct</span> <span class='hs-layout'>(</span><span class='hs-varid'>i</span><span class='hs-comment'>-</span><span class='hs-num'>1</span><span class='hs-layout'>)</span> <span class='hs-varid'>j</span> <span class='hs-layout'>(</span><span class='hs-varid'>tail</span> <span class='hs-varid'>s</span><span class='hs-layout'>)</span>
<a name="line-278"></a>                                         <span class='hs-keyword'>in</span> <span class='hs-varid'>reverse</span> <span class='hs-varop'>$</span> <span class='hs-varid'>reconstruct</span> <span class='hs-layout'>(</span><span class='hs-varid'>length</span> <span class='hs-varid'>s</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>length</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>reverse</span> <span class='hs-varid'>s</span><span class='hs-layout'>)</span>
</pre></body>
</html>
